<?phpdate_default_timezone_set("Etc/GMT-3");global $connect;$connect = mysqli_connect("localhost", "root", "admin", "db_cpma");$filename='FarmersCleaned';$today=date('Y-m-d');//define('CSV_PATH','E:/apollo_2016/projectRepos/Repo_CPM/New_form6/'); define('CSV_PATH','/Library/WebServer/Documents/CPMA/Dev_CPM/new_folder/'); $csv_file = CSV_PATH . "".$filename.".csv"; ini_set('auto_detect_line_endings',TRUE); 	$file = fopen($csv_file, "r");	$header_read = false;		$index_mapping = array(							'frameno' => 0, 							'tbl_farmersid' => 1,							'tbl_tradersid' => 2,							'tbl_villageagentid' => 3,							'valuechain' => 4,							'zone' => 5,							'farmersdistrict' => 6,							'farmerssubcounty' => 7,							'farmervillage' => 8,							'farmersname' => 9,							'age' => 10,							'gender' => 11,							'farmertel' => 12,//														);/* readfile($csv_file); */$i=0;$stable1= "INSERT INTO `tbl_farmers` (					`tbl_farmersId`,					`tbl_tradersId`, 					`tbl_villageAgentId`, 					`tbl_villageagent_groupsId`,					`reportingPeriod`,					`groupName`,					`farmersDistrict`,					`farmersSubcounty`,					`farmersName`,					`memberDstart`,					`memberStatus`,					`farmersDob`,					`farmersVillage`,					`farmersSex`, 					`farmersTel`,					`hhName`, 					`hhDob`, 					`hhSex`,					`hhHeadDStart`, 					`hhArea`,					`hsComposition`,					`farmers_e_pay`,					`display`,					`submittedBy`,					`updatedBy`,					`year`,					`farmerCrop`					 ) VALUES ";while (($line = fgetcsv($file)) !== FALSE) {					  if(!$header_read) {			determin_indexes($line);			$header_read = true;	  }	  else {			$stable1.= process_data_record($line,$i);							  }	 $i++;	}	echo $stable1;	 //$a=mysqli_query($connect, $stable1) or die (mysqli_error($connect)); 		fclose($file);		function determin_indexes($header) {		global $index_mapping;				$index_mapping['frameno'] = array_search('frameno', $header); 		$index_mapping['tbl_farmersid'] = array_search('tbl_farmersid', $header);			$index_mapping['tbl_tradersid'] = array_search('tbl_tradersid', $header);			$index_mapping['tbl_villageagentid'] = array_search('tbl_villageagentid', $header);			$index_mapping['valuechain'] = array_search('valuechain', $header);			$index_mapping['zone'] = array_search('zone', $header);			$index_mapping['farmersdistrict'] = array_search('farmersdistrict', $header);			$index_mapping['farmerssubcounty'] = array_search('farmerssubcounty', $header);			$index_mapping['farmervillage'] = array_search('farmervillage', $header);			$index_mapping['farmersname'] = array_search('farmersname', $header);			$index_mapping['age'] = array_search('age', $header);			$index_mapping['gender'] = array_search('gender', $header);			$index_mapping['farmertel'] = array_search('farmertel', $header);						}		function fixtags($text){	$text = htmlspecialchars($text);	$text = preg_replace("/=/", "=\"\"", $text);	$text = preg_replace("/&quot;/", "&quot;\"", $text);	$tags = "/&lt;(\/|)(\w*)(\ |)(\w*)([\\\=]*)(?|(\")\"&quot;\"|)(?|(.*)?&quot;(\")|)([\ ]?)(\/|)&gt;/i";	$replacement = "<$1$2$3$4$5$6$7$8$9$10>";	$text = preg_replace($tags, $replacement, $text);	$text = preg_replace("/=\"\"/", "=", $text);	return $text;	}	 	function removeWhiteSpaces($string){					$newString=preg_replace('/\s+/', '', $string);				return $newString;					}	function converStringToInt($string){			$newString = intval($string);		return $newString;			}	function converStringToFloat($string){			$newString = floatval($string);			$finalValue=number_format($newString, 12, '.', '');		return $finalValue;			}	function converStringToMysqlInsertSafe($link,$string){			$newString = htmlspecialchars(addslashes($string));			$finalString=mysqli_real_escape_string($link, $newString);		return $finalString;			}	function dateConversion($dateString){		$newDate = @date('Y-m-d', @strtotime($dateString));		return $newDate;	}	 	function process_data_record($record,$i) {		global $index_mapping;				date_default_timezone_set("Etc/GMT-3");		$connect = mysqli_connect("localhost",  "root", "admin", "db_cpma");		if (!$connect)		{		$msg_at_readtime='Error in connectivity';							}						$msg_at_readtime='none';		$today=date('Y-m-d');		$yesterday=date('Y-m-d',strtotime("-1 days"));		$timestamp=date('Y-m-d h:i:s');		@mysqli_autocommit($connect,FALSE);				$table1='tbl_farmers';					$tbl_farmersid=($record[$index_mapping['tbl_farmersid']]); 	 			$tbl_tradersid=($record[$index_mapping['tbl_tradersid']]); 				$tbl_villageagentid=($record[$index_mapping['tbl_villageagentid']]); 				$valuechain=($record[$index_mapping['valuechain']]); 				$zone=($record[$index_mapping['zone']]); 				$farmersdistrict=($record[$index_mapping['farmersdistrict']]); 				$farmerssubcounty=($record[$index_mapping['farmerssubcounty']]); 				$farmervillage=($record[$index_mapping['farmervillage']]); 				$farmersname=($record[$index_mapping['farmersname']]); 				$age=($record[$index_mapping['age']]); 				$gender=($record[$index_mapping['gender']]); 				$farmertel=($record[$index_mapping['farmertel']]); 						  		  //clean id's			$tbl_farmersId=converStringToInt(removeWhiteSpaces($tbl_farmersid));			$tbl_tradersid=converStringToInt(removeWhiteSpaces($tbl_tradersid));			$tbl_villageagentid=converStringToInt(removeWhiteSpaces($tbl_villageagentid));			$zone=converStringToInt(removeWhiteSpaces($zone));			$farmersdistrict=converStringToInt(removeWhiteSpaces($farmersdistrict));			$farmerssubcounty=converStringToInt(removeWhiteSpaces($farmerssubcounty));																		//default age for farmers whose age is unknown=200			$age=(!empty($age) or ($age !=''))?$age:200;			$year=(date('Y')-$age);			$month='01';			$date='01';			$dob=''.$year.'-'.$month.'-'.$date.'';			$tbl_villageagent_groupsId=21983;			$reportingPeriod='Apr - Sep';			$groupName='No Group';			$memberDstart=$today;			$memberStatus='';			$hhName=$farmersname;			$hhDob=$dob;			$hhSex=strtoupper(substr($gender,0,1));			$hhHeadDStart=$today;			$hhArea='0.000';			$hsComposition=($gender =='Male')?'maleNoFemale':'femaleNoMale';			$submittedBy='aasiimwe';			$updatedBy='aasiimwe';			$farmerCrop=$valuechain;			if (is_numeric($tbl_farmersId)) {												//==============insert values into $table1==========================						$stable1= " (									'".$tbl_farmersId."',									'".$tbl_tradersid."',									'".$tbl_villageagentid."',									'".$tbl_villageagent_groupsId."',									'".$reportingPeriod."',									'".$groupName."',									'".$farmersdistrict."',									'".$farmerssubcounty."',									'".$farmersname."',									'".$memberDstart."', 									'".$memberStatus."',									'".$dob."', 									'".$farmervillage."', 									'".$gender."', 									'".$farmertel."', 									'".$hhName."', 									'".$hhDob."', 									'".$hhSex."', 									'".$hhHeadDStart."',  									'".$hhArea."',  									'".$hsComposition."',  									'n/a', 									'Yes', 									'".$submittedBy."', 									'".$updatedBy."', 									'2016',									'".$farmerCrop."'),";																													//  echo $stable1;						}		return $stable1;				//@mysqli_commit($connect);	}		?>